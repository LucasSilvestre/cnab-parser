(ns cnab-parser.itau
  (:require [cnab-parser.core :refer :all]
            [clojure.string :as s]
            [clojure.java.io :as io]))

(def ^:const ^:private itau400-parser
  (make-cnab-parser (-> "itau400.edn"
                        io/resource
                        io/file)))

(defmethod parse-cnab-header-arquivo [:itau400 :retorno]
  [cnab padrao cnab-type]
  (let [{{:keys [header_arquivo]} :retorno} itau400-parser]
    (into {} (map (fn [[k spec]] [k (parse-cnab-field cnab spec)]) header_arquivo))))

(comment (parse-cnab-header-arquivo "02RETORNO01COBRANCA       098765432101        ABCASDLAPKJSDKLKASJDAKLSADKSKD341BANCO ITAU S.A.11111111111BPI22222222222                                                                                                                                                                                                                                                                                   000001" :itau400 :retorno))

(defmethod parse-cnab-detalhes [:itau400 :retorno]
  [cnabs padrao cnab-type]
  (let [{{{:keys [segmento_1 segmento_2 segmento_4 segmento_5] :as detalhes} :detalhes} :retorno} itau400-parser]
    #_(prn "seg1 " segmento_1)
    (letfn [(parse-detalhe [cnab map-spec]
              (let [ans (into {} (map (fn [[k spec]] [k (parse-cnab-field cnab spec)]) map-spec))]
                #_(prn "ans " ans)
                #_(prn "cnab " cnab)
                #_(prn "map-spec "map-spec)
                ans
                ))
            (try-parse [cnab-unit]
              (try-args parse-detalhe [[cnab-unit segmento_1]
                                       [cnab-unit segmento_2]
                                       [cnab-unit segmento_4]
                                       [cnab-unit segmento_5]]))]
      (map #(let [{:keys [args-pos args res] :as td} (try-parse %)]
              (def a td)
              (case args-pos
                0 {:segmento_1 res}
                1 {:segmento_2 res}
                2 {:segmento_4 res}
                3 {:segmento_5 res})) cnabs))))

(comment #(map (fn [segmento _] (when-let [ans (try-parse %)]
                                          {segmento ans})) ))


(comment (def detalhes
(split-cnab "10227635377000173293800421456                                 00001458            109000014585             I020203200         00001458            05032000000001252413412861308000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000410000000000000         00000000000000000000000AIDA MARIA BITTENCOURT DE FABI                                        000002
10227635377000173293800421456                                 00001459            109000014593             I020203200002      00001459            29022000000001088873412897708000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360000000000000         00000000000000000000000FRANCISCO ARMANDO CORDEIRO ARA                                        000003
10227635377000173293800421456                                 00001460            109000014601             I020203200002      00001460            09032000000000625593410667608000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000         00000000000000000000000PEDRO MAGNO LOPES BATISTA 0193                                        000004
10227635377000173293800421456                                 00001461            109000014619             I020203200002      00001461            09032000000001470923410158608000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000490000000000000         00000000000000000000000CHRISLEIDE APARECIDA SUTTANI 2                                        000005
10227635377000173293800421456                                 00001462            109000014627             I020203200002      00001462            09032000000002542513412897708000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000840000000000000         00000000000000000000000JULIERY RODRIGUES MEDEIROS 102                                        000006
10227635377000173293800421456                                 00001463            109000014635             I020203200002      00001463            09032000000001199963412861308000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000390000000000000         00000000000000000000000ENGENHO DO SABOR RESTAURANTE E                                        000007
10227635377000173293800421456                                 00001464            109000014643             I020203200002      00001464            09032000000001271523410382208000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420000000000000         00000000000000000000000FABIANO ELIAS SALVADOR PASTELA                                        000008
10227635377000173293800421456                                 00001465            109000014650             I020203200002      00001465            09032000000004496583410548808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001490000000000000         00000000000000000000000CLONE PIZZA LTDA                                                      000009
10227635377000173293800421456                                 00001466            109000014668             I020203200002      00001466            09032000000001291343412897708000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000430000000000000         00000000000000000000000WURSTERIA COMERCIO DE ALIMENTO                                        000010
10227635377000173293800421456                                 00001467            109000014676             I020203200002      00001467            09032000000001612903414684708000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000530000000000000         00000000000000000000000EVELIN ARRAES DA COSTA FERREIR                                        000011
10227635377000173293800421456                                 00001468            109000014684             I020203200002      00001468            09032000000001214523414792808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000         00000000000000000000000BEAN BURGER COMERCIO DE ALIMEN                                        000012
10227635377000173293800421456                                 00001469            109000014692             I020203200002      00001469            09032000000001090693410374908000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360000000000000         00000000000000000000000RITA DE CASSIA MACEDO DA SILVA                                        000013
10227635377000173293800421456                                 00001470            109000014700             I020203200002      00001470            09032000000000889853410667608000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000290000000000000         00000000000000000000000THAYANNE MAYARA MELO CALIXTO 0                                        000014
10227635377000173293800421456                                 00001471            109000014718             I020203200002      00001471            09032000000000502053417434408000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000         00000000000000000000000CLAUDIA BUENO                                                         000015
10227635377000173293800421456                                 00001472            109000014726             I020203200002      00001472            09032000000003001433412897708000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000         00000000000000000000000THUANY ANTUNES MEDEIROS 119994                                        000016
10227635377000173293800421456                                 00001473            109000014734             I020203200002      00001473            09032000000003297643410321008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001090000000000000         00000000000000000000000NONNA TELLA ALIMENTOS LTDA                                            000017
10227635377000173293800421456                                 00001474            109000014742             I020203200002      00001474            09032000000001506213414683908000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000         00000000000000000000000ELAINNE DA COSTA DIAS 02636315                                        000018
10227635377000173293800421456                                 00001475            109000014759             I020203200002      00001475            09032000000011058723410611408000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003680000000000000         00000000000000000000000CHIQUITEIRA COMERCIO DE CALCAD                                        000019
10227635377000173293800421456                                 00001476            109000014767             I020203200002      00001476            09032000000003560633410146108000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001180000000000000         00000000000000000000000HERCULES AUGUSTO GARCIA FIGUEI                                        000020
10227635377000173293800421456                                 00001477            109000014775             I020203200002      00001477            29022000000002403783412861308000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000         00000000000000000000000L.C. DA SILVA REIS BENTO - HAM                                        000021
10227635377000173293800421456                                 00000914            109000009148             I060203200002      00000914            13012000000001339106330001808000000000000000000000000000000000000000000000000000000000000000000000000000000000000013874400000000048340000000000000   03032000000000000000000000000R C TASSI RESTAURANTE E PIZZAR                                      B5000022
10227635377000173293800421456                                 00001262            109000012621             I060203200002      00001262            22022000000000591052376876708000000000000000000000000000000000000000000000000000000000000000000000000000000000000006045800000000013530000000000000   03032000000000000000000000000EDUARDA NAYAZA DE OLIVEIRA SIQ                                      B3000023
10227635377000173293800421456                                 00001265            109000012654             I060203200002      00001265            22022000000001694560330662708000000000000000000000000000000000000000000000000000000000000000000000000000000000000017334900000000038930000000000000   03032000000000000000000000000PIZZARIA BELLA PARMA.D EIRELI                                       B3000024
10227635377000173293800421456                                 00001315            109000013157             I060203200002      00001315            27022000000001142196330001808000000000000000000000000000000000000000000000000000000000000000000000000000000000000011665500000000024360000000000000   03032000000000000000000000000CAMILA MARIA PEREIRA 062254679                                      B5000025
10227635377000173293800421456                                 00001325            109000013256             I060203200002      00001325            28022000000001345367563210208000000000000000000000000000000000000000000000000000000000000000000000000000000000000013735800000000028220000000000000   03032000000000000000000000000KAREN CINTRA SOUZA 37204383842                                      B3000026
10227635377000173293800421456                                 00001329            109000013298             I060203200002      00001329            28022000000001680520334022008000000000000000000000000000000000000000000000000000000000000000000000000000000000000017158100000000035290000000000000   03032000000000000000000000000CLMV COMEDORIA EIRELI                                               B3000027
10227635377000173293800421456                                 00001336            109000013363             I060203200002      00001336            01032000000001026762370645208000000000000000000000000000000000000000000000000000000000000000000000000000000000000010267600000000000000000000000000   03032000000000000000000000000LUIS GONZAGA FRANCA MORAES 524                                      B3000028
10227635377000173293800421456                                 00001337            109000013371             I060203200         00001337            29022000000001220983410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000012209800000000000000000000000000   03032000000000000000000000000ALAN ROSA CRISTINO                                                  CK000029
10227635377000173293800421456                                 00001338            109000013389             I060203200002      00001338            29022000000002392353410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000023923500000000000000000000000000   03032000000000000000000000000ANA APARECIDA CELESTINO FERREI                                      CK000030
10227635377000173293800421456                                 00001339            109000013397             I060203200002      00001339            29022000000001899723410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000018997200000000000000000000000000   03032000000000000000000000000BAZZE ROTISSERIE LTDA                                               CK000031
10227635377000173293800421456                                 00001340            109000013405             I060203200002      00001340            29022000000001644583410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000016445800000000000000000000000000   03032000000000000000000000000BROT-HAUS INDUSTRIA DE ALIMENT                                      CK000032
10227635377000173293800421456                                 00001341            109000013413             I060203200002      00001341            29022000000003021483410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000030214800000000000000000000000000   03032000000000000000000000000COZINHA GRILL EIRELI                                                CK000033
10227635377000173293800421456                                 00001342            109000013421             I060203200         00001342            29022000000000916303410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000009163000000000000000000000000000   03032000000000000000000000000DANIEL ZARAHI FERREIRA AMARAL                                       CK000034
10227635377000173293800421456                                 00001343            109000013439             I060203200         00001343            29022000000001361123410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000013611200000000000000000000000000   03032000000000000000000000000DIOGO DOS SANTOS MELO                                               CK000035
10227635377000173293800421456                                 00001344            109000013447             I060203200         00001344            29022000000006062983410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000060629800000000000000000000000000   03032000000000000000000000000EDJANE CLEVES DA SILVA                                              CK000036
10227635377000173293800421456                                 00001345            109000013454             I060203200         00001345            29022000000000522083410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000005220800000000000000000000000000   03032000000000000000000000000FRANCISCO MARCIANO DOS SANTOS                                       CK000037
10227635377000173293800421456                                 00001346            109000013462             I060203200002      00001346            29022000000013024653410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000130246500000000000000000000000000   03032000000000000000000000000GILMAR FERNANDES PEIXOTO 06196                                      CK000038
10227635377000173293800421456                                 00001347            109000013470             I060203200002      00001347            29022000000002337343410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000023373400000000000000000000000000   03032000000000000000000000000HELENA DE NAZARE DE ALMEIDA PI                                      CK000039
10227635377000173293800421456                                 00001348            109000013488             I060203200         00001348            29022000000001271363410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000012713600000000000000000000000000   03032000000000000000000000000JAIRO GOFFI JUNIOR                                                  CK000040
10227635377000173293800421456                                 00001349            109000013496             I060203200002      00001349            29022000000003223933410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000032239300000000000000000000000000   03032000000000000000000000000KATSUMARU CULINARIA JAPONESA L                                      CK000041
10227635377000173293800421456                                 00001350            109000013504             I060203200002      00001350            29022000000001538563410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000015385600000000000000000000000000   03032000000000000000000000000LARISSA ALIGNANI 09580550921                                        CK000042
10227635377000173293800421456                                 00001351            109000013512             I060203200002      00001351            29022000000001245603410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000012456000000000000000000000000000   03032000000000000000000000000MARCOS NASCIMENTO MARTINS LTDA                                      CK000043
10227635377000173293800421456                                 00001352            109000013520             I060203200002      00001352            29022000000003691003410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000036910000000000000000000000000000   03032000000000000000000000000MARIA ELIANA BARBOSA DOS SANTO                                      CK000044
10227635377000173293800421456                                 00001353            109000013538             I060203200002      00001353            29022000000001629593410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000016295900000000000000000000000000   03032000000000000000000000000MARIA RITA FONSECA BLASIO 3113                                      CK000045
10227635377000173293800421456                                 00001354            109000013546             I060203200002      00001354            29022000000001192363410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000011923600000000000000000000000000   03032000000000000000000000000MARILMA SILVEIRA MEIRELES 0138                                      CK000046
10227635377000173293800421456                                 00001355            109000013553             I060203200002      00001355            29022000000000758513410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000007585100000000000000000000000000   03032000000000000000000000000MARIO LUIZ VIEIRA DA SILVA 886                                      CK000047
10227635377000173293800421456                                 00001356            109000013561             I060203200002      00001356            29022000000008080243410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000080802400000000000000000000000000   03032000000000000000000000000SABOR NA BRASA COMERCIO DE ALI                                      CK000048
10227635377000173293800421456                                 00001357            109000013579             I060203200002      00001357            29022000000008080243410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000080802400000000000000000000000000   03032000000000000000000000000SABOR NA BRASA NEGOCIOS TRANSP                                      CK000049
10227635377000173293800421456                                 00001358            109000013587             I060203200002      00001358            29022000000008080243410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000080802400000000000000000000000000   03032000000000000000000000000SABOR NA BRASA SITIO CERCADO C                                      CK000050
10227635377000173293800421456                                 00001359            109000013595             I060203200         00001359            29022000000009938843410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000099388400000000000000000000000000   03032000000000000000000000000SONIA SUELY PANSIERI                                                CK000051
10227635377000173293800421456                                 00001361            109000013611             I060203200002      00001361            29022000000003306101041733508000000000000000000000000000000000000000000000000000000000000000000000000000000000000033061000000000000000000000000000   03032000000000000000000000000GLEIDE SELMA MOREIRA FIEL                                           B3000052
10227635377000173293800421456                                 00001362            109000013629             I060203200002      00001362            29022000000004073700334580708000000000000000000000000000000000000000000000000000000000000000000000000000000000000040737000000000000000000000000000   03032000000000000000000000000SPAZIO FORGIONI RESTAURANTE E                                       B3000053
10227635377000173293800421456                                 00001363            109000013637             I060203200002      00001363            29022000000006157623417227208000000000000000000000000000000000000000000000000000000000000000000000000000000000000061576200000000000000000000000000   03032000000000000000000000000VRS FOODS HAMBURGUERIA LTDA                                         BL000054
10227635377000173293800421456                                 00001365            109000013652             I060203200002      00001365            29022000000003641863413071808000000000000000000000000000000000000000000000000000000000000000000000000000000000000036418600000000000000000000000000   03032000000000000000000000000CARLOS EDUARDO SILVA DE MOURA                                       BL000055
10227635377000173293800421456                                 00001367            109000013678             I060203200002      00001367            29022000000007498253410019008000000000000000000000000000000000000000000000000000000000000000000000000000000000000074982500000000000000000000000000   03032000000000000000000000000GISELI SOARES DE LIMA                                               CK000056
10227635377000173293800421456                                 00001370            109000013702             I060203200002      00001370            29022000000005585740331512308000000000000000000000000000000000000000000000000000000000000000000000000000000000000055857400000000000000000000000000   03032000000000000000000000000ANDERSON CLAYTON SANTIAGO                                           B3000057
10227635377000173293800421456                                 00001371            109000013710             I060203200002      00001371            29022000000000486212371969508000000000000000000000000000000000000000000000000000000000000000000000000000000000000004862100000000000000000000000000   03032000000000000000000000000IRIS CASTELLO DE SOUZA CAETANO                                      B3000058
10227635377000173293800421456                                 00001375            109000013751             I060203200002      00001375            29022000000002687603416023608000000000000000000000000000000000000000000000000000000000000000000000000000000000000026876000000000000000000000000000   03032000000000000000000000000ANA MARIA COUTO DE CARVALHO ME                                      BL000059
10227635377000173293800421456                                 00001378            109000013785             I060203200002      00001378            29022000000000942443410273308000000000000000000000000000000000000000000000000000000000000000000000000000000000000009424400000000000000000000000000   03032000000000000000000000000ROBSON RODRIGO GOIS COMERCIO D                                      BL000060
10227635377000173293800421456                                 00001379            109000013793             I060203200002      00001379            29022000000000615083890266708000000000000000000000000000000000000000000000000000000000000000000000000000000000000006150800000000000000000000000000   03032000000000000000000000000MARIA ALESSANDRA RODRIGUES COS                                      B3000061
10227635377000173293800421456                                 00001382            109000013827             I060203200002      00001382            29022000000000804683410540508000000000000000000000000000000000000000000000000000000000000000000000000000000000000008046800000000000000000000000000   03032000000000000000000000000GUILHERME MYNSSEN PEREIRA MILL                                      BL000062
10227635377000173293800421456                                 00001383            109000013835             I060203200002      00001383            29022000000000445390010852408000000000000000000000000000000000000000000000000000000000000000000000000000000000000004453900000000000000000000000000   03032000000000000000000000000MANUELA ALBUQUERQUE DE SOUSA                                        B5000063
10227635377000173293800421456                                 00001384            109000013843             I060203200002      00001384            29022000000001493060330041408000000000000000000000000000000000000000000000000000000000000000000000000000000000000014930600000000000000000000000000   03032000000000000000000000000CRISTIANO SOMMER LEME 30899289                                      B3000064
10227635377000173293800421456                                 00001391            109000013918             I060203200002      00001391            29022000000005681320334316608000000000000000000000000000000000000000000000000000000000000000000000000000000000000056813200000000000000000000000000   03032000000000000000000000000ARS PIZZARIA E LANCHES LTDA                                         B3000065
10227635377000173293800421456                                 00001392            109000013926             I060203200002      00001392            02032000000000849893411295508000000000000000000000000000000000000000000000000000000000000000000000000000000000000008498900000000000000000000000000   03032000000000000000000000000RED DOG LANCHONETE LTDA                                             BL000066
10227635377000173293800421456                                 00001394            109000013942             I060203200002      00001394            02032000000006974307563300108000000000000000000000000000000000000000000000000000000000000000000000000000000000000069743000000000000000000000000000   03032000000000000000000000000M  D PIZZARIA LTDA                                                  B3000067
10227635377000173293800421456                                 00001396            109000013967             I060203200002      00001396            02032000000006744282370621308000000000000000000000000000000000000000000000000000000000000000000000000000000000000067442800000000000000000000000000   03032000000000000000000000000JOAO BATISTA DE MENDONCA FILHO                                      B2000068
10227635377000173293800421456                                 00001397            109000013975             I060203200002      00001397            02032000000000598912370972008000000000000000000000000000000000000000000000000000000000000000000000000000000000000005989100000000000000000000000000   03032000000000000000000000000JOAO FELIPE DE MELO SALES 3903                                      B3000069
10227635377000173293800421456                                 00001399            109000013991             I060203200002      00001399            02032000000001300310010179208000000000000000000000000000000000000000000000000000000000000000000000000000000000000013003100000000000000000000000000   03032000000000000000000000000FEIJOCA RESTAURANTE LTDA                                            B2000070
10227635377000173293800421456                                 00001400            109000014007             I060203200002      00001400            02032000000000538473411468808000000000000000000000000000000000000000000000000000000000000000000000000000000000000005384700000000000000000000000000   03032000000000000000000000000FRANCISCA UBERLONIA DA SILVA                                        BL000071
10227635377000173293800421456                                 00001401            109000014015             I060203200002      00001401            03032000000000620510333872908000000000000000000000000000000000000000000000000000000000000000000000000000000000000006205100000000000000000000000000   03032000000000000000000000000RODRIGO DELL AGNELO 0410170690                                      B3000072
10227635377000173293800421456                                 00001477            109000014775             I060203200002      00001477            29022000000002403783418136408000000000000000000000000000000000000000000000000000000000000000000000000000000000000024037800000000000000000000000000   03032000000000000000000000000L.C. DA SILVA REIS BENTO - HAM                                      BL000073
10227635377000173293800421456                                 00000502            109000005021             I090203200002      00000502            01111900000001563043417788308000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000         00000000000000000000000IGOR NUNES DOS SANTOS 29070803                                        000074
10227635377000173293800421456                                 00000509            109000005096             I090203200002      00000509            03111900000002335323417788308000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000         00000000000000000000000A  J RESTAURANTE CHINES LTDA                                          000075
10227635377000173293800421456                                 00000000            109000000006             I540203200000173   00000000            000000000000000000034100000  000000003875200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000         00000000000000000000000                                                                      000076
10227635377000173293800421456                                 00000000            109000000006             I520203200000019   00000000            000000000000000000034100000  000000000425600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000         00000000000000000000000                                                                      000077
10227635377000173293800421456                                 00000000            199000000000              430203200000045   00000000            000000000000000000034100000  000000000499500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000         00000000000000000000000                                                                      000078" 400)

           )
         (last (parse-cnab-detalhes detalhes :itau400 :retorno))
         )


(defmethod parse-cnab-trailer-arquivo [:itau400 :retorno]
  [cnab padrao cnab-type]
  (let [{{:keys [trailer_arquivo]} :retorno} itau400-parser]
    (into {} (map (fn [[k spec]] [k (parse-cnab-field cnab spec)]) trailer_arquivo))))

(comment (parse-cnab-trailer-arquivo "9201341          000000000000000000000000000000          000000000000000000000000000000                                                  000000000000000000000000000000          0000035300000084445941  02/03S002360000007700000020467957                                                                                                                                                                000079" :itau400 :retorno)) 

(defmethod parse-cnab [:itau400 :retorno]
  [cnab padrao cnab-type]
  (let [[header & detalhes_trailer] (split-cnab (slurp cnab) 400)
        {:keys [retorno]} itau400-parser
        detalhes (butlast detalhes_trailer)
        trailer (last detalhes_trailer)]
    {:header_arquivo (parse-cnab-header-arquivo header padrao cnab-type)
     :detalhes (parse-cnab-detalhes detalhes padrao cnab-type)
     :trailer_arquivo (parse-cnab-trailer-arquivo trailer padrao cnab-type)}
    ))


(comment (parse-cnab (io/file "/home/severo/Documentos/cnab-exemplo/CN02030A.RET")
                     :itau400
                     :retorno
                     ))

